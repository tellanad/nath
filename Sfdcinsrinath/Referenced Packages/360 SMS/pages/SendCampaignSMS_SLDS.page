<apex:page id="pageID" extensions="tdc_tsw.SendCampaignSMSCtrl" standardController="Campaign" showQuickActionVfHeader="false" docType="html-5.0" standardStylesheets="false" sidebar="false" showHeader="false" >
<html xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <head>
      <link href = "https://rawgit.com/mervick/emojionearea/master/dist/emojionearea.min.css" rel = "stylesheet"/>

        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>SMS APP</title>  
        <!-- styles -->
        <apex:stylesheet value="{!URLFOR($Resource.tdc_tsw__SLDS214, 'assets/styles/salesforce-lightning-design-system.min.css')}"/>
         <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet"/>
         
        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
        <!-- Scripts -->
        <apex:includeScript value="{!URLFOR($Resource.tdc_tsw__SMSAppRS, '/js/jquery-2.2.1.min.js')}"/>
        <link rel="stylesheet" href="//code.jquery.com/ui/1.12.0/themes/base/jquery-ui.css"/>
        <script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>
        
        <apex:stylesheet value="{!URLFOR($Resource.tdc_tsw__SMSAppRS, '/css/jquery-ui.css')}"/>
        <apex:includeScript value="{!URLFOR($Resource.tdc_tsw__SMSAppRS, '/js/jquery-ui.js')}"/>
        <apex:stylesheet value="{!URLFOR($Resource.tdc_tsw__datetimepicker, '/flatpickr.min.css')}"/>
        <apex:includeScript value="{!URLFOR($Resource.tdc_tsw__datetimepicker, '/flatpickr.min.js')}"/>
        <script src = "https://rawgit.com/mervick/emojionearea/master/dist/emojionearea.js"></script>
        <style type="text/css">
            .slds-spinner_container {position: fixed;}
            .slds-card {
                max-width: 800px;
                margin: auto;
                border: none;
            }

            .slds-card__body {
                background: #fff;
                padding: 1.5rem;
                padding-bottom: 4rem;
            }
            .slds-card__body .slds-card__body {
                padding-bottom: 0.5rem;
                border: 1px solid #f4f6f9;
            }

            .slds-form-element {
                margin-bottom: 1rem;
            }

            .slds-form-element__help {
                margin-top: 0
            }
            .slds-form-element .slds-radio {
                display: block;
                clear: both;
                max-width: 150px;
            }
            
            .Date_time .datepicker_css{
                max-width: 220px;
                background-color: #fff;
                color: #16325c;
                border: 1px solid #d8dde6;
                border-radius: .25rem;
                width: 100%;
                transition: border .1s linear,background-color .1s linear;
                display: inline-block;
                padding: 0 1rem 0 .75rem;
                line-height: 1.875rem;
                min-height: calc(1.875rem + (1px * 2));
                margin-right: 10px;
            }
            .Date_time select{
                max-width: 115px;
                background-color: #fff;
                color: #16325c;
                border: 1px solid #d8dde6;
                border-radius: .25rem;
                width: 100%;
                transition: border .1s linear,background-color .1s linear;
                display: inline-block;
                padding: 0 1rem 0 .75rem;
                line-height: 1.875rem;
                min-height: calc(1.875rem + (1px * 2));
            }
            .message {
                background: none;
                border:none;
                margin:0;
                padding:0;
                margin-bottom: 15px;
            }
            .infoM3 .msgIcon, .infoMedium { display: none;}
           .message .messageText {margin:0; color:red;font-size:.8rem}
            html body.sfdcBody {padding:0}
        </style>
    </head> 
  <body>
    <apex:form id="formID">

   
      <article class="slds-card">
         <div class="slds-card__header slds-grid">
            <header class="slds-media slds-media--center slds-has-flexi-truncate">
               <div class="slds-media__body slds-truncate slds-text-align--center">
                  <h2>
                     <a href="javascript:void(0);" class="slds-text-link--reset">
                     <span class="slds-text-heading--small">Create Message</span>
                     </a>
                  </h2>
               </div>
            </header>
         </div>
         <div class="slds-card__body">
         <div class="form">
            <!-- Error message -->
            <apex:outputPanel id="ErrorMessage"  style="color:red;">
              <apex:pageMessages escape="false" />
            </apex:outputPanel>


            <apex:outputPanel rendered="{!!isNotCampaignMember}">
                <apex:outputPanel rendered="{!isMultipleSender}" >
                    <div class="slds-form-element slds-m-top--medium slds-medium-size--1-of-2">
                        <label class="slds-form-element__label" for="select-01">Sender Number</label>
                        <div class="slds-select_container">
                            <apex:selectList size="1" value="{!senderPhoneKey}" styleClass="slds-select">
                                <apex:selectOptions value="{!lstSender}"/>
                            </apex:selectList> 
                        </div>
                    </div>
                </apex:outputPanel>           

                <article class="slds-card">
                  <!--    <apex:pageBlock > -->
                        <apex:outputPanel layout="block" rendered="{!isContactsVisible}"> 
                            <div class="slds-card__header slds-grid">
                                <header class="slds-media slds-media--center slds-has-flexi-truncate">
                                    <h2>
                                        <span class="slds-text-heading--small">Contacts({!contactIdList.size})</span>
                                    </h2>
                                </header>
                            </div>
                        </apex:outputpanel> 
                   <!--   </apex:pageBlock> --> 
                   
                    <div class="slds-card__body">
                        <div class="slds-form-element">
                            <div class="slds-form-element little_border">
                                <div class="slds-form--compound ">
                                    <div class="slds-form-element__group">
                                        <div class="slds-form-element__row">
                                            <!-- render send to option -->      
                                            <div class="slds-form-element slds-size--1-of-2">
                                                <apex:outputPanel rendered="{!isMultipleContactPhoneApi}" >
                                                    <label class="slds-form-element__label" for="input-01">Send To</label>
                                                    <div class="slds-select_container">
                                                        <apex:selectList size="1" value="{!contactSelectedPhoneApi}" styleClass="slds-select">
                                                          <apex:selectOptions value="{!lstContactSendTo}"/>
                                                        </apex:selectList>
                                                    </div>
                                                </apex:outputPanel>
                                            </div>                                            

                                            <div class="slds-form-element slds-size--1-of-2">
                                                <apex:outputPanel rendered="{!isContactsVisible}"> 
                                                    <label class="slds-form-element__label" for="input-02">Choose Template</label>
                                                    <div class="slds-select_container">
                                                        <apex:selectList value="{!contactSelectedTemplate}" size="1" styleClass="slds-select" onChange="jsFun1();" id="selectContactTemplateSelectList">
                                                            <apex:selectOptions value="{!allContactTemplates}"/>
                                                        </apex:selectList>
                                                        <script>
                                                            function jsFun1(){
                                                              var elem=document.getElementById('{!$Component.pageID:formID:selectContactTemplateSelectList}');
                                                              actionFun2();
                                                            }
                                                        </script>
                                                    </div>
                                                </apex:outputPanel>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <apex:outputPanel id="pgId"  rendered="{!isContactsVisible}">
                                    <div class="slds-form-element">
                                       <label class="slds-form-element__label" for="textarea-input-01">Message</label>
                                       <div class="slds-form-element__control">
                                          <apex:inputTextarea value="{!contactMessageText}" rows="4" id="contactTemplateText" onkeyup="jsfun1(this);" html-maxlength="1000" styleClass="slds-textarea abc" />
                                       </div>
                                       <span class="help-block" style="color: #8199af;"><apex:outputText value="You Can Enter Up To 1000 Characters" id="optextId" rendered="true"></apex:outputText></span>
                                    </div>
                                </apex:outputPanel>
                            
                            </div>
                        </div>
                    </div>
                </article>
                

                <!-- Lead Sectoion -->
                <article class="slds-card">
                   <!-- <apex:pageBlock > -->
                      <apex:outputPanel layout="block" rendered="{!isLeadsVisible}"> 
                          <div class="slds-card__header slds-grid">
                            <header class="slds-media slds-media--center slds-has-flexi-truncate">
                               <h2>
                                  <span class="slds-text-heading--small">Leads({!leadIdList.size})</span>
                               </h2>
                            </header>
                          </div>
                      </apex:outputpanel> 
                    <!--</apex:pageBlock>-->
                   
                    <div class="slds-card__body">
                        <div class="slds-form-element">
                            <div class="slds-form-element little_border">
                                <div class="slds-form--compound ">
                                    <div class="slds-form-element__group">
                                        <div class="slds-form-element__row">
                                            <div class="slds-form-element slds-size--1-of-2">
                                                <apex:outputPanel rendered="{!isMultipleLeadPhoneApi}" >
                                                    <label class="slds-form-element__label" for="input-01">Send To</label>
                                                    <div class="slds-select_container">
                                                        <apex:selectList size="1" value="{!leadSelectedPhoneApi}" styleClass="slds-select">
                                                            <apex:selectOptions value="{!lstLeadSendTo}"/>
                                                        </apex:selectList>
                                                    </div>
                                                </apex:outputPanel>
                                            </div>
                                            
                                            <div class="slds-form-element slds-size--1-of-2">
                                                <apex:outputPanel rendered="{!isLeadsVisible}">
                                                    <label class="slds-form-element__label" >Choose Template</label>
                                                    <div class="slds-select_container">
                                                        <apex:selectList value="{!leadSelectedTemplate}" size="1" styleClass="slds-select" onChange="jsFun2();" id="selectLeadTemplateSelectList">
                                                            <apex:selectOptions value="{!allLeadTemplates}"/>
                                                        </apex:selectList>
                                                        <script>
                                                            function jsFun2(){
                                                              var elem=document.getElementById('{!$Component.pageID:formID:selectLeadTemplateSelectList}');
                                                              actionFun1();
                                                            }
                                                        </script>
                                                    </div>
                                                </apex:outputPanel>
                                            </div>                                            
                                        </div>
                                    </div>
                                </div>
                                <apex:outputPanel id="leadTemplateTextpgId" rendered="{!isLeadsVisible}">
                                    <div class="slds-form-element">
                                        <label class="slds-form-element__label" for="textarea-input-01">Message</label>
                                        <div class="slds-form-element__control">
                                            <apex:inputTextarea value="{!leadMessageText}" id="leadTemplateText" rows="4" onkeyup="jsfun2(this);" html-maxlength="1000" styleClass="slds-textarea" />
                                        </div>
                                        <span class="help-block" style="color: #8199af;"><apex:outputText value="You Can Enter Up To 1000 Characters" id="optextId2" rendered="true" styleClass="help-block" ></apex:outputText></span>
                                    </div>
                                </apex:outputPanel>
                            </div>
                        </div>
                    </div>
                </article>
                
                <!-- checkbox -->
                <apex:outputPanel rendered="{!isSchedulable}">  
                    <div class="slds-form-element">
                        <div class="slds-form-element__control">
                          <label class="slds-checkbox">
                              <apex:inputCheckbox value="{!isChecked}" onclick="allowScheduling('{!$Component.CheckboxId}')" id="CheckboxId"  />
                              <span class="slds-checkbox--faux"></span>
                              <span class="slds-form-element__label"> Schedule </span>
                          </label>
                        </div>
                    </div>
                </apex:outputPanel>

                <apex:outputPanel rendered="{!isChecked}" styleClass="Date_time">
                    <fieldset class="slds-form-element">
                      <legend class="slds-form-element__legend slds-form-element__label">Schedule Type</legend>
                      <div class="slds-form-element__control">
                        <label class="slds-radio" >
                          <input type="radio" name="schedule" value="daily" id="lead" onchange="radioFun(this.value)" checked="checked"/>
                          <span class="slds-radio--faux"></span>
                          <span class="slds-form-element__label">Schedule Once</span>
                        </label>
                        <label class="slds-radio" >
                          <input type="radio" name="schedule" value="everyday" id="education" onchange="radioFun(this.value)" />
                          <span class="slds-radio--faux"></span>
                          <span class="slds-form-element__label">Schedule Daily</span>
                        </label>
                        <label class="slds-radio" >
                          <input type="radio" name="schedule" value="everymonth" id="education" onchange="radioFun(this.value)" />
                          <span class="slds-radio--faux"></span>
                          <span class="slds-form-element__label">Schedule Monthly</span>
                        </label>
                      </div>
                    </fieldset>
                </apex:outputPanel>

                <!--<apex:outputPanel rendered="{!isChecked}" styleClass="Date_time" id="scheduleDateSec">
                     <apex:selectRadio value="{!radioSelectedValue}" onchange="radioFun(this)">
                        <apex:selectOptions value="{!items}"/>
                    </apex:selectRadio> 
                    <p>
                      <apex:inputText value="{!scheduledDate}" styleClass="date_input datepicker" html-placeholder="Start Date"/>          
                      <apex:SelectList value="{!scheduledTime}" size="1"  >
                          <apex:selectOptions value="{!FirstReminder}"/>    
                      </apex:SelectList>
                    </p>
                    <apex:outputPanel rendered="{!IF(OR(isEveryDay == true,isEveryMonth == true),true,false)}">                   
                        <apex:inputText value="{!endDate}" styleClass="date_input datepicker slds-m-top--medium" html-placeholder="End Date" /> 
                    </apex:outputPanel> 
                    
                    <script>
                        setTimeout(function(){
                            $(".datepicker").datepicker({ dateFormat: "yy-mm-dd" }).val();
                                $('#loader').hide();
                            },300)                       
                    </script> 
                </apex:outputPanel>-->
                <apex:outputPanel id="scheduleDateSec" rendered="{!isChecked}" styleClass="Date_time">
                            <div class="slds-grid slds-wrap">
                                <div class="slds-col slds-size--1-of-1">
                                <p class="">
                                  <apex:inputText value="{!scheduledDateTime}" styleClass="datepicker datepicker_css" html-placeholder="Start Date" html-data-input="" />
                                  <a class="input-button" onclick="$('.datepicker').val('')"><i class="fa fa-close"></i></a>
                                </p>
                                </div>
                                <div class="slds-col slds-size--1-of-4 slds-col--padded">
                                    <!-- <div class="slds-form-element">
                                        <div class="slds-form-element__control">
                                            <div class="slds-select_container">
                                                <apex:SelectList value="{!scheduledTime}" size="1"  styleClass="slds-select">
                                                     <apex:selectOptions value="{!FirstReminder}"/>    
                                                </apex:SelectList>
                                            </div>
                                        </div>
                                    </div>-->
                                </div>
                                <div class="slds-col slds-size--1-of-4 slds-col--padded">
                                </div>
                            </div>
                            
                            <p>
                            <apex:outputPanel rendered="{!IF(OR(isEveryDay == true,isEveryMonth == true),true,false)}">                   
                                 <apex:inputText value="{!endDate}" styleClass="datepicker2 datepicker_css slds-m-top--medium" html-placeholder="End Date" />
                                  <a class="input-button" onclick="$('.datepicker2').val('')"><i class="fa fa-close"></i></a> 
                            </apex:outputPanel>
                            
                            </p> 
                           <script>
                                setTimeout(function(){
                                  // $(".datepicker").datepicker({ dateFormat: "yy-mm-dd" }).val();
                                  flatpickr(".datepicker", {
                                    enableTime: true,
                                    minuteIncrement : 1
                                  });
                                  flatpickr(".datepicker2", {
                                    enableTime: false
                                  });
                                  $('#loader').hide();
                                },300)
                             </script>     
                        </apex:outputPanel>

            </apex:outputPanel> 
            <div class="slds-docked-form-footer">
                <apex:outputPanel rendered="{!!isNotCampaignMember}">
                    <apex:outputPanel rendered="{!isChecked}"> 
                        <apex:commandButton action="{!Schedule}" value="Schedule" styleClass="slds-button slds-button--brand slds-m-right--medium" style="margin-left:20px;" rerender="formID" onComplete="CloseAndRefresh();" onclick="disableButton(this)"/> 
                    </apex:outputPanel>
                    
                    <apex:outputPanel rendered="{!!isChecked}"> 
                        <apex:commandButton action="{!sendMessage}" styleClass="slds-button slds-button--brand slds-m-right--medium" onComplete="CloseAndRefresh();" rerender="formID" onclick="disableButton(this)" value="Send" />
                    </apex:outputPanel>

                    <apex:commandButton action="{!cancel}" styleClass="slds-button slds-button--neutral" style="margin-left:20px;" onComplete="CloseAndRefresh();" rerender="formID" value="Cancel"/>                    
                </apex:outputPanel>
            </div>
         </div>
         </div>
      </article>

      <apex:actionFunction name="actionFun2" action="{!getContactTemplate}" reRender="pgId" oncomplete="jsfun1(document.getElementById('{!$Component.contactTemplateText}'));"/>

      <apex:actionFunction name="actionFun1" action="{!getLeadTemplate}" reRender="leadTemplateTextpgId" oncomplete="jsfun2(document.getElementById('{!$Component.leadTemplateText}'));"/>

      <apex:actionFunction name="showSchedule"  reRender="formID" >
          <apex:param name="allowSchedule" value="" assignTo="{!isChecked}"/>
      </apex:actionFunction>

      <apex:actionFunction name="radioButtonValue" action="{!scheduleType}"  reRender="scheduleDateSec" ><!-- action="{!scheduleType}" -->
          <apex:param name="radioButton" value="" assignTo="{!radiSelectedValue}"/>
      </apex:actionFunction>
      <script>
      /*$(document).ready(function() {
                emojiMethod();
        });
        
        function emojiMethod(){
            $(".abc").emojioneArea({
                pickerPosition: "left",
                tonesStyle: "bullet"
           }); 
        }*/
    
      function jsfun1(currelm){
          var isTrue = isGSMAlphabet(currelm.value);
            //alert('====isTrue:'+ isTrue);
            var segment = 1;
            var nonGsmLength = currelm.value.length;
            var strLength = currelm.value.length + count(currelm.value,'{') + count(currelm.value,'}') + count(currelm.value,'[') + count(currelm.value,']');
            if(isTrue)
            {
                 if(strLength <= 160){
                   segment = 1;
                 }
                 else{
                      if(strLength % 153 == 0)
                          segment = (strLength/153);
                      else
                         segment = (strLength/153)+1;
                  }
            }
            else
            {
               if(nonGsmLength <= 70){
                   segment = 1;
                 }
                 else{
                    if(nonGsmLength%67 == 0)
                        segment = (nonGsmLength/67);
                    else
                        segment = (nonGsmLength/67)+1;
                    }       
            }       
                
              // document.getElementById('{!$Component.optextId}').style.color="black";
            document.getElementById('{!$Component.pageID:formID:optextId}').innerHTML='You Have Entered '+currelm.value.length+' Characters.     '+'Segment :'+parseInt(segment,10)+'(Segment will depend on merge fields)';
      } 
      function jsfun2(currelm){
          var isTrue = isGSMAlphabet(currelm.value);
            //alert('====isTrue:'+ isTrue);
            var segment = 1;
            var nonGsmLength = currelm.value.length;
            var strLength = currelm.value.length + count(currelm.value,'{') + count(currelm.value,'}') + count(currelm.value,'[') + count(currelm.value,']');
            if(isTrue)
            {
                 if(strLength <= 160){
                   segment = 1;
                 }
                 else{
                      if(strLength % 153 == 0)
                          segment = (strLength/153);
                      else
                         segment = (strLength/153)+1;
                  }
            }
            else
            {
               if(nonGsmLength <= 70){
                   segment = 1;
                 }
                 else{
                    if(nonGsmLength%67 == 0)
                        segment = (nonGsmLength/67);
                    else
                        segment = (nonGsmLength/67)+1;
                    }       
            }       
                
             //  document.getElementById('{!$Component.optextId}').style.color="black";
            document.getElementById('{!$Component.pageID:formID:optextId2}').innerHTML='You Have Entered '+currelm.value.length+' Characters.     '+'Segment :'+parseInt(segment,10)+'(Segment will depend on merge fields)';
      } 
      
      function isGSMAlphabet(text) {
            //alert(text);
        var regexp = new RegExp("^[A-Za-z0-9 @!\"#$%&'`()*+,_\\-./:;<=>?^{}\\\\\\[~\\]|\\r\\n]*$");
        //alert(regexp.test(text)) ;
        return regexp.test(text);
        
        }
      
      function count(text , c) { 
          var result = 0, i = 0;
          for(i;i<text.length;i++)
          {
              if(text[i]==c)
                result++;
          }     
          //alert('=====result:'+result);
          return result;
          
        }

    
      function CloseAndRefresh(){
            var isMobile = false;
            if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                isMobile = true;
            }
          isError = '{!isError}';
          if(isError == 'false'){
            if(isMobile == true)
             {
                sforce.one.navigateToSObject('{!$CurrentPage.parameters.id}', 'detail');
              }
              else
                {
                    window.top.location.href="/{!$CurrentPage.parameters.id}";
                    window.opener.location.reload(true);
                }  
             /*var url = (window.location != window.parent.location)  ? document.referrer  : document.location;
             window.top.location.href = url;
             window.opener.location.reload(true);*/
          }
          else{
          		window.scrollBy(0, -500);
          }
      }
   
      function disableButton(buttonObj){
          buttonObj.disabled=true;
       }
       
        function allowScheduling(checkBoxId)
        {
            $('#loader').show();
            if(document.getElementById(checkBoxId).checked) {
              showSchedule(true);  
            } else
            {    
               showSchedule(false);  
            }
        }
        
        function radioFun(e) {
        //console.log('this is radio button');
        console.log(e);
        $('#loader').show();
        radioButtonValue(e);
      }
        
    </script>
    </apex:form>
    

    <div class="slds-spinner_container" id="loader" style="display:none">
      <div class="slds-spinner--brand slds-spinner slds-spinner--medium" role="alert">
        <span class="slds-assistive-text">Loading</span>
        <div class="slds-spinner__dot-a"></div>
        <div class="slds-spinner__dot-b"></div>
      </div>
    </div>


    

  </body>
</html>
</apex:page>