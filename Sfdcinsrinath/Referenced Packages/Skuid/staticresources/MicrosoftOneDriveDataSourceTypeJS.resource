"use strict";!function(a){var b=a.$,c=b.each,d=b.Deferred,e=b.ajax,f=a.utils,g=f.getObjectProperty,h=a.dataSource,i=h.utils,j=a.constants,k=j.DATASOURCE,l=j.DISPLAY_TYPES,m=j.MIME_TYPES,n=j.HTTP_VERBS,o=m.JSON,p=l.DATETIME,q=l.NUMBER,r=l.OBJECT,s=l.STRING,t=l.IMAGE,u=n.GET,v=n.PATCH,w=n.DELETE,x=k.SEARCH_CONDITION,y=function(a,b){var d={};return c(a,function(a,c){c.inactive||(d[c.sourceParam||c.name]=encodeURI(f.mergeAsTextInContext(c.value,b)))}),d},z=function(a){var b,c,d=a.model,e=d.conditions,f=y(e,a),g=f[x],h=f["Parent Folder"],i=f.extension||"";h?-1===h.indexOf("/")?c="/_api/v2.0/drive/items/"+h+"/children":(h=h.split(" ").join("%20"),b=h.split("/"),c="/_api/v2.0/drive/root:"+h,i||-1!==b[b.length-1].indexOf(".")||(c+=":/children")):c="/_api/v2.0/drive/root/children",g&&(c=h&&-1===h.indexOf("/")?"/_api/v2.0/drive/items/"+h+"/view.search?q="+g:"/_api/v2.0/drive/root/view.search?q="+g),a.request.url=c};h.getDataSourceType("MicrosoftOneDrive")||new h.core.RESTDataSourceTypeBase({name:"MicrosoftOneDrive",coerceRequest:function(a){var b=a.type,c=a.request.data;if(!a.request.url)if("query"===b)z(a);else if(("update"===b||"delete"===b)&&(a.request.url="/_api/v2.0/drive/items/"+a.originalRecordId,"update"===b)){var d=c.parentDirectory||"";a.request.data.parentReference={path:"/drive/root:"+d},delete a.request.data.parentDirectory}a.request.headers={Accept:o}},parseSuccessfulLoadResponse:function(a,c,d,e){var g,h,i,j,k=this,l=k.parseResponseBodyAsJSON(a.body),m=c.pathToContent,n=e.conditions,o=[];if(b.each(n,function(a,b){"extension"===b.name?g=b.value:"Parent Folder"===b.name&&(h=b.value)&&(i=h.split("/"))}),j=h&&-1!==i[i.length-1].indexOf(".")?l:m?f.getObjectProperty(l,m):l,b.isArray(j))b.each(j,function(a,b){var c;if(g){var d=b.name.split(".");c=d?d.slice(-1)[0]:""}if(g&&-1===c.indexOf(g))delete j[a];else{var e=b.parentReference.path,h=e?e.split(":")[1]:b.parentReference.id;b.createdByUserName=f.getObjectProperty(b,"createdBy.user.displayName"),b.lastModifiedByUserName=f.getObjectProperty(b,"lastModifiedBy.user.displayName"),b.parentDirectory=h,b.oneUp=h.substring(0,h.lastIndexOf("/")),b.downloadUrl=b["@content.downloadUrl"],o.push(b)}}),d.data=o,j=o;else{var p=j.parentReference.path,q=p?p.split(":")[1]:j.parentReference.id;j.createdByUserName=f.getObjectProperty(j,"createdBy.user.displayName"),j.lastModifiedByUserName=f.getObjectProperty(j,"lastModifiedBy.user.displayName"),j.parentDirectory=q,j.oneUp=q.substring(0,q.lastIndexOf("/")),j.downloadUrl=j["@content.downloadUrl"],d.data=j=[j]}},getUploadMethods:function(){function b(b,d,e,g,h,i){function j(a){if(a&&a.body){var b=a.body;if(b&&b.error&&b.error.message)return b.error.message}return"Had an error"}function k(b,c){return a.utils.inPlatform(a.constants.NATIVE)?b:"atob"===c?atob(b):"btoa"===c?btoa(b):void 0}function l(){var a;g({fileName:e.filename||b.name}),a=s&&-1===s.indexOf("/")?A+"/_api/v2.0/drive/items/"+s+":/"+v+":/upload.createSession":s&&"/"!==s?A+"/_api/v2.0/drive/root:"+s+"/"+v+":/upload.createSession":A+"/_api/v2.0/drive/root:/"+v+":/createUploadSession";var c=y.createHTTPRequest({url:a,method:"POST",headers:{"Content-Length":0,Accept:o}});return y.makeRequest(c)}function m(){var a=k(u[0],"atob").length-1;return i({loaded:D,total:t}),y.makeRequest(y.createHTTPRequest({url:r,headers:{"Content-Range":"bytes 0-"+a+"/"+B,"Content-Length":u[0].length,Accept:o},contentType:"application/octet-stream",method:"PUT",body:u[0]})).then(function(a){1===t?h():n(a)},function(a){h({message:j(a)})})}function n(a){D++,i({loaded:D,total:t}),y.authenticate(e).then(function(){if(D===t)p(a);else{var b="string"==typeof a.body?JSON.parse(a.body):a.body,c=b.nextExpectedRanges[0].split("-")[0],d=parseInt(c,10)+k(u[D-1],"atob").length-1;y.makeRequest(y.createHTTPRequest({url:r,headers:{"Content-Range":"bytes "+c+"-"+d+"/"+B,"Content-Length":u[D-1].length,Accept:o},contentType:"application/octet-stream",method:"PUT",body:u[D-1]})).then(function(a){n(a)},function(a){h({message:j(a)})})}})}function p(a){var b="string"==typeof a.body?JSON.parse(a.body):a.body,c=b.nextExpectedRanges[0].split("-")[0],d=parseInt(c,10)+k(u[D-1],"atob").length-1;y.makeRequest(y.createHTTPRequest({url:r,headers:{"Content-Range":"bytes "+c+"-"+d+"/"+B,"Content-Length":u[D-1].length,Accept:o},contentType:"application/octet-stream",method:"PUT",body:u[D-1]})).then(function(a){202===a.statusCode?h({message:"Upload failed!"}):h()},function(a){h({message:j(a)})})}function q(a,b){for(var c=a.length,d=[],e=Math.ceil(c/b),f=0;f<b;f++)d[f]=k(a.slice(e*f,e*(f+1)),"btoa");return d}var r,s,t,u,v=encodeURIComponent(f.renameFileWhileKeepingExtension(b.name,f.mergeAsTextInContext(e.filename,e))),w=new FileReader,x=e.model,y=x.dataSource,z=x.conditions,A=y.serviceUrl,B=b.size,C=a.platform.getMaxProxyRequestPayload(),D=1;c(z,function(a,b){s=b.value||""}),w.readAsBinaryString(b),w.onloadend=function(){u=w.result,t=Math.ceil(B/C),y.authenticate(e).then(function(){u=q(u,t),l().then(function(a){var b="string"==typeof a.body?JSON.parse(a.body):a.body;r=b.uploadUrl,m()},function(a){h({message:j(a)})})})}}return{"Direct Upload":{label:"Direct Upload",canRunPostUploadSnippet:!0,upload:b,needsModelInContext:!0}}},parseAdditionalQueries:function(a,c,d,e){var f="string"==typeof a.body?JSON.parse(a.body):a.body;f=g(f,e.method.pathToContent),b.isArray(f)&&(f=f[0]),c.fields.map(function(a){a.defer&&b.inArray(a.id,e.method.fields)>-1&&(d[a.id]=g(f,a.path))})},createActions:function(b){return{"create-folder":{label:"Create new folder",builderProps:[{label:"Model with Parent Folder Condition",id:"model",type:"model",helptext:"Will take the value in this model's parent folder condition, and use it as the parent folder for the new folder",entryFilter:f.filterByDataSourceAndEntity(b.name,"File")},{label:"Folder Name",id:"foldername",type:"string"}],runtimeExecution:function(b,g,h,i){var j,k=a.$M(b.attr("model")),l=k.dataSource,m=l.serviceUrl,n="",o=f.mergeAsTextInContext(b.attr("foldername"),h),p=d();return c(k.conditions,function(a,b){"Parent Folder"===b.sourceParam&&(n=f.mergeAsTextInContext(b.value,h)||n)}),j={name:o,folder:{},"@name.conflictBehavior":"rename"},e(n&&-1===n.indexOf("/")?{url:m+"/_api/v2.0/drive/items/"+n+"/children",headers:{Authorization:"Bearer "+i.authentication.responseBody.access_token,"Content-Type":"application/json"},method:"POST",dataType:"json",data:JSON.stringify(j),success:function(){p.resolve()},error:function(a){p.reject(a)}}:{url:m+"/_api/v2.0/drive/root:"+n,headers:{Authorization:"Bearer "+i.authentication.responseBody.access_token},method:"GET",dataType:"json",success:function(a){e({url:m+"/_api/v2.0/drive/items/"+a.id+"/children",headers:{Authorization:"Bearer "+i.authentication.responseBody.access_token,"Content-Type":"application/json"},method:"POST",dataType:"json",data:JSON.stringify(j),success:function(){p.resolve()},error:function(a){p.reject(a)}})},error:function(a){p.reject(a)}}),p.promise()}},copy:{label:"Copy a File",builderProps:[{label:"Model with Parent Folder Condition",id:"model",type:"model",helptext:"Will take the value in this model's parent folder condition, and use it as the parent folder for the new folder",entryFilter:f.filterByDataSourceAndEntity(b.name,"File")},{label:"File Name",id:"filename",type:"string"}],runtimeExecution:function(b,g,h){var i,j,k=a.$M(b.attr("model")),l=h.row,m=l.parentReference.path,n=m?m.split(":")[1]:l.parentReference.id,o=k.dataSource,p=o.serviceUrl,q="",r=f.mergeAsTextInContext(b.attr("filename"),h),s=d();return c(k.conditions,function(a,b){"Parent Folder"===b.sourceParam&&(q=f.mergeAsTextInContext(b.value,h)||q)}),j={parentReference:l.parentReference,name:r},i=q?q&&-1===q.indexOf("/")?p+"/_api/v2.0/drive/items/"+l.id+"/action.copy":p+"/_api/v2.0/drive/root:"+n+"/"+l.name+":/action.copy":p+"/_api/v2.0/drive/root:/"+l.name+":/action.copy",e({url:i,headers:{Authorization:"Bearer "+o.authentication.responseBody.access_token,"Content-Type":"application/json",Prefer:"response-async"},method:"POST",dataType:"json",data:JSON.stringify(j),success:function(){s.resolve()},error:function(a){s.reject(a)}}),s.promise()}}}},getEntityList:i.getEntityListStatic,queryEntityMetadata:i.queryEntityMetadataStatic,getActions:i.getActionsStatic,extendedProperties:{composer:{unomittableFields:!0,hasEntityOptions:!0},hasDefaultSearch:!0,canServerSearch:!0,hasGlobalSearchEntities:!0,"x-metadata":{__skuid_fieldDefaults:{File:{displaytype:s,editable:!1,createable:!1,accessible:!0}},File:{idFields:["id"],nameField:"name",label:"File",labelPlural:"Files",fields:[{id:"id",inlineHelpText:"Identifier of the drive.","x-alwaysinclude":!0},{id:"name",inlineHelpText:"Name of the drive.",editable:!0},{id:"createdByUserName"},{id:"createdDateTime",displaytype:p},{id:"lastModifiedByUserName"},{id:"lastModifiedDateTime",displaytype:p},{id:"webUrl"},{id:"parentReference",displaytype:r,accessible:!1},{id:"size",displaytype:q},{id:"parentDirectory",editable:!0},{id:"oneUp",label:"Directory Up"},{id:"downloadUrl",label:"Download Link"},{id:"smallThumbnail",label:"Thumbnail (Small)",displaytype:t,defer:!0,path:"small.url"},{id:"mediumThumbnail",label:"Thumbnail (Medium)",displaytype:t,defer:!0,path:"medium.url"},{id:"largeThumbnail",label:"Thumbnail (Large)",displaytype:t,defer:!0,path:"large.url"}],methods:{query:{url:"",verb:u,contentType:o,pathToContent:"value",additionalRequests:[{url:"/_api/v2.0/drive/items/{{id}}/thumbnails",verb:u,contentType:o,pathToContent:"value",fields:["smallThumbnail","mediumThumbnail","largeThumbnail"]}]},update:{url:"",verb:v,contentType:o,receiveDataAs:"recordinbody",successIf:"responsefieldispresent",successField:"name"},"delete":{url:"",verb:w,contentType:o},search:{url:"/_api/v2.0/drive/root/view.search?q={{search}}",verb:u,contentType:o,pathToContent:"value"}},defaultConditions:[{sourcetype:"param",sourceparam:"Parent Folder",name:"Parent Folder",label:"Path to File/Folder",state:"filterableon",value:""},{sourcetype:"param",sourceparam:"extension",name:"extension",label:"File Extension",state:"filterableon",value:""}]}}}})}(skuid);