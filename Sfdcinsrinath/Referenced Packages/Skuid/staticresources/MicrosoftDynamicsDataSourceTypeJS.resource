"use strict";!function(a){var b=a.$,c=b.each,d=a.utils,e=a.dataSource.utils,f={None:!1,SystemRequired:!0,ApplicationRequired:!0,Recommended:!1};if(!a.dataSource.getType("MicrosoftDynamics")){var g=a.dataSource.core,h=g.ODataDataSourceTypeBase;new h({name:"MicrosoftDynamics",coerceSaveItemRequest:function(c,d){var e=["Edm.DateTimeOffset","Edm.DateTime"];c.headers["Content-ID"]=""+d.key;var f=d.model&&d.model.fieldsMap;f&&b.each(c.data,function(b,d){f[b]&&-1!==e.indexOf(f[b].edmtype)&&(c.data[b]=a.time.parseDateTimeString(d).toISOString())})},supportsBatch:function(){return b.Deferred().resolve(!0).promise()},coerceAdditionalQueries:function(a){a.requestUri=a.requestUri.replace("guid'","").replace("')",")")},getEntitySetFromEntityTypeName:function(a,b){var c=this,d=c.getEntityType(a,b);return d.entitySetName?c.getEntitySet(d.entitySetName,b):h.prototype.getEntitySetFromEntityTypeName(a,b)},getDefaultFieldsForReferenceField:function(b,c,d){return[a.utils.getFieldReference(b,c,d),b+"."+c.keyField]},getNameFieldURLForReferenceField:function(b,c,e){var f=this,g=b.model,h=b.row,i=b.metadata,j=b.options.fieldXML,k=j&&j.attr("redirecttype")||"datasourcedefault",l=g.dataSource,m=l.metadata,n=h&&h[b.id]&&h[b.id][i.keyField],o=i.ref&&f.getEntityType(i.ref,m),p=o&&o.name,q=a.dataSource.DataSourceType.prototype.getNameFieldURLForReferenceField,r=l.serviceUrl.substring(0,l.serviceUrl.indexOf("/api/")+1);if("datasourcedefault"!==k)return q(b,c,e);if(n&&p)return'<a href="'+(r+"main.aspx?etn="+d.encodeHTML(p)+"&id="+d.encodeHTML(n)+"&pagetype=entityrecord")+'" target="_blank">'+e+"</a>"},coerceEntitySetList:function(a){for(var b=this,c=a.length-1;c>=0;c--)d.isString(a[c])?a.splice(c,1):a[c].value=b.trimDefaultNamespace(a[c].value)},populateExtraMetadata:function(a){var c=this,e=a.metadata,f=["MetadataId","DisplayCollectionName","EntitySetName","PrimaryIdAttribute","DisplayName","SchemaName","LogicalName","PrimaryNameAttribute"],g={dataSource:a,requestUri:d.combineUrls(a.serviceUrl,"EntityDefinitions?$select="+f.join(","))};return c.makeODataRequest(a,g).then(function(a){var d=c.getSchema(e,"Microsoft.Dynamics.CRM"),f=a.value,g=d.entityTypeMap,h=d.entitySetMap;return b.each(f,function(a,b){var c=b.LogicalName,d=g[c],e=b.PrimaryNameAttribute,f=b.DisplayName,i=b.PrimaryIdAttribute,j=b.DisplayCollectionName;if(d){i&&d.key&&d.key[0]&&d.key[0].propertyRef[0]&&(d.key[0].propertyRef[0].name=i),d.nameField=e,d.MetadataId=b.MetadataId,d.entitySetName=b.EntitySetName;var k=h[d.entitySetName];k&&j&&j.UserLocalizedLabel&&(k.label=j.UserLocalizedLabel.Label),f&&f.UserLocalizedLabel&&(d.label=f.UserLocalizedLabel.Label)}}),e})},trimDefaultNamespace:function(a){return 0===a.indexOf("Microsoft.Dynamics.CRM")?a.substring("Microsoft.Dynamics.CRM".length+1):a},getEntityDefinitionEndpointForAttributes:function(a,b){return d.combineUrls(b.serviceUrl,"EntityDefinitions("+a.MetadataId+")/Attributes")},getSpecificPicklistEndpoint:function(a,b,c){var e=this,f=e.getEntityDefinitionEndpointForAttributes(a,b);return d.combineUrls(f+"("+c+")","Microsoft.Dynamics.CRM.PicklistAttributeMetadata?$select=LogicalName&$expand=OptionSet($select=Options),GlobalOptionSet($select=Options)")},getPicklistMetadataForEntityProps:function(a,d){var e,f=this,g=f.getSchema(d.metadata),h=g.entitySetMap,i=g.entityTypeMap,j={},k=[];return c(a,function(a,b){var d=h[f.trimDefaultNamespace(b.objectName)];(e=d&&i[f.trimDefaultNamespace(d.entityType)])&&c(b.fields,function(a,b){var c=e.propertyMap[b.id];c&&"Picklist"===c.attributeType&&(j[JSON.stringify({entityTypeName:e.name,propId:c.metadataId})]=!0)})}),c(j,function(a){a=JSON.parse(a);var b=i[a.entityTypeName],c=f.getSpecificPicklistEndpoint(b,d,a.propId);k.push(f.makeCachedODataRequest(d,{requestUri:c}).then(function(a){return f.handleNewFieldMetadata([a],b)}))}),b.when.all(k).then(function(){e.hasExtraMetadata=!0})},parseOptions:function(a){return b.map(a,function(a){return{value:a.Value,label:d.getObjectProperty(a,"Label.UserLocalizedLabel.Label")||a.Value}})},appendAttributesToProperty:function(a,b){var c=this,e=b.OptionSet||b.GlobalOptionSet,f=e&&e.Options;if(f)return void(a.picklistEntries=c.parseOptions(f));a.metadataId=b.MetadataId,a.defaultValue=b.DefaultFormValue,a.attributeType=b.AttributeType,a.helptext=d.getObjectProperty(b,"Description.UserLocalizedLabel.Label")||"",a.label=d.getObjectProperty(b,"DisplayName.UserLocalizedLabel.Label")||a.name,a.format=b.Format,a.accessible=b.IsValidForRead,a.createable=b.IsValidForCreate,a.editable=b.IsValidForUpdate,a.isRequired=b.RequiredLevel&&b.RequiredLevel.Value},isDefEditable:function(a){return!1!==a.editable&&!a.isFieldOnReferenceField},isDefCreateable:function(a){return!1!==a.createable&&!a.isFieldOnReferenceField&&"Edm.Guid"!==a.type},isDefRequired:function(a){return f[a.isRequired]&&!a.isFieldOnReferenceField&&"Edm.Guid"!==a.type},coerceFieldMetadata:function(a,b){b.helptext&&(a.inlineHelpText=b.helptext),b.label&&(a.label=b.label),b.metadataId?a.metadataId=b.metadataId:a.label=e.makeLabelFromId(a.id),b.picklistEntries?(a.displaytype="PICKLIST",a.picklistEntries=b.picklistEntries,!b.defaultValue&&0!==b.defaultValue||-1===b.defaultValue||(a.defaultValue=b.defaultValue)):null!==b.defaultValue&&b.defaultValue!==undefined&&(a.defaultValue=b.defaultValue),"Picklist"===b.attributeType&&(a.displaytype="PICKLIST")},handleNewFieldMetadata:function(a,b){var d=this;c(a,function(a,c){var e=b.propertyMap[c.LogicalName]||b.navigationPropertyMap[c.LogicalName];e&&d.appendAttributesToProperty(e,c)})},getDefaultNamespace:function(){return"Microsoft.Dynamics.CRM"},coerceConditionValue:function(a,b){var c=b.picklistEntries,d=c&&c.length;if(!d||("0"|a)===a)return a;for(var e=0;e<d;e++)if(c[e].label===a)return c[e].value+"";return a},getExtraEntityMetadata:function(a,d){var e=this,f=[],g=a.metadata,h=e.getSchema(g,"Microsoft.Dynamics.CRM"),i=h.entitySetMap,j=h.entityTypeMap,k={};return c(d,function(a,b){k[b.objectName]=!0}),c(k,function(b){var k,l=i[e.trimDefaultNamespace(b)];l&&(k=j[e.trimDefaultNamespace(l.entityType)])&&(k.builtMaps||e._buildEntitySpecificMaps(k,h,g),k.hasExtraMetadata||f.push(e.makeCachedODataRequest(a,{requestUri:e.getEntityDefinitionEndpointForAttributes(k,a)}).then(function(f){e.handleNewFieldMetadata(f.value,k);var g=[];return c(d,function(a,c){c.objectName===b&&g.push(c)}),e.getPicklistMetadataForEntityProps(g,a)})))}),b.when.all(f)},getCachedODataRequest:function(a,b){return a.getCacheProperty(b.requestUri.split(".").join("\\."),{cacheLocation:"sessionStorage"})},setCachedODataRequest:function(a,b,c){return a.setPersistentCacheProperty(b.requestUri.split(".").join("\\."),c,{cacheLocation:"sessionStorage"})},makeCachedODataRequest:function(a,c,d){var e=this,f=e.getCachedODataRequest(a,c);return f?b.Deferred().resolve(f).promise():e.makeODataRequest(a,c).then(function(b){return d&&(b=d(b)),e.setCachedODataRequest(a,c,b),b})}})}}(skuid);