"use strict";!function(a){function b(a){return!!a&&r.indexOf(a)>=0}function c(a){return l.isFunction(a)?function(b,c){a({done:b,message:c})}:function(){}}function d(a,b){return function(){var c=j.Deferred(),d=Array.prototype.slice.call(arguments);return window.setTimeout(function(){var e=a.apply(b||window,d);c.resolve(e)}),c.promise()}}function e(a,b,c){return j.when.apply(j,a.reduce(function(a,c){var d=a[a.length-1];return d.length>=b&&a.push(d=[]),d.push(c),a},[[]]).map(c)).then(function(){return Array.prototype.slice.call(arguments)})}function f(a,b){b||(b={});var f=b.progressCallback,n=c(f),o=b.relaxFieldChecks;if(!a)return j.Deferred().reject("Invalid Argument: Expecting an array of page objects").promise();j.isArray(a)||(a=[a]),n(!1,"Examining Pages... ");var q,r,A,B=a.filter(function(a){return a}).map(function(a){return a.row||a}),C=B.filter(function(a){return!0===a[v]}),D=C.filter(function(a){return a[t]&&!a[w]}).map(function(a){return a[t]}),E=B.filter(function(a){return o||x.every(function(b){return a.hasOwnProperty(b)})}),F=E.map(function(a){return a[t]}),G=Object.keys(B.filter(function(a){var b=E.indexOf(a)<0;return a[t]&&b}).map(function(a){return a[t]}).concat(C.filter(function(a){return a[w]}).reduce(function(a,b){var c=b[w].records;return j.isArray(c)?a.concat(c.filter(function(a){return a})):a},[]).map(function(a){return a[t]}).filter(function(a){return E.indexOf(a)<0})).reduce(function(a,b){return a[b]=1,a},{}));return 0===G.length&&0===D.length?q=j.when(E):(n(!1,"Querying for Additional Information..."),r=[],A=function(a,b){r[a]=b;var c,d=r.reduce(function(a,b){return a+b},0);c=d>=1048576?j.number(d/1048576,1)+" MB":d>=1024?j.number(d/1024,1)+" KB":j.number(d)+" bytes",n(!1,"Querying for Additional Information... ("+c+")")},q=e(D,200,function(a,b){return j.get({url:"/services/data/v39.0/query?q=SELECT Id, (SELECT Id FROM skuid__Pages__r) FROM skuid__Page__c WHERE Id IN ('"+a.join("','")+"')",headers:{Authorization:"Bearer "+l.userInfo.sessionId},xhr:function(){var a=j.ajaxSettings.xhr();return a.onprogress=function(a){var c=a.loaded;l.isNumber(c)&&A(b,c)},a}}).then(function(a){return a.records.reduce(function(a,b){return a.concat(b[w].records||[])},[]).map(function(a){return a[t]}).filter(function(a){return G.indexOf(a)<0&&F.indexOf(a)<0})})}).then(function(a){return a.reduce(function(a,b){return a.concat(b)},[])}).then(function(a){return e(G.concat(a),200,function(a,b){return j.get({url:"/services/data/v39.0/query?q=SELECT "+x.join(",")+",skuid__MasterPage__r."+x.join(",skuid__MasterPage__r.")+" FROM skuid__Page__c WHERE Id IN ('"+a.join("','")+"')",headers:{Authorization:"Bearer "+l.userInfo.sessionId},xhr:function(){var a=j.ajaxSettings.xhr();return a.onprogress=function(a){var c=a.loaded;l.isNumber(c)&&A(b,c)},a}}).then(function(a){return a.records})})}).then(function(a){return E=E.concat(a.reduce(function(a,b){return a.concat(b)},[]))})),q.then(function(a){n(!1,"Processing Additional Information...");var b={};return j.when.apply(j,a.map(d(function(a){var c,d,e,f,g=a[t],h=a[u],l=function(a){return function(b,c){return b+(a[c]?a[c]:"")}},o=a.skuid__MasterPage__r&&s.reduce(l(a.skuid__MasterPage__r),"")||"",q=s.reduce(l(a),""),r=[];n(!1,"Processing "+h);try{c=o.length>0&&j(y,m(o)),e=j(y,m(q))}catch(v){return b}return d=c&&c.filter(z).toArray()||[],f=d.concat(e.filter(z).toArray()),k(f,function(a,b){b=j(b);var c=b.attr("location"),d=b.text().trim();"inline"==c?d&&r.push(d+";\n"):"inlinesnippet"==c?d&&r.push("skuid.snippet.register('"+b.attr("name")+"',function(args) {"+d+"\n});\n"):"inlinecomponent"==c&&d&&r.push("skuid.componentType.register('"+b.attr("name")+"',function(elem) {"+d+"\n});\n")}),0===r.length?b:(r.splice(0,0,"(function(skuid){\n"),r.push("}(window.skuid));"),{name:i(a),description:"Skuid Support File for "+h+" ("+g+")",content:[{name:"inlineresources.js",content:r.join("")}],contentType:p.ZIP})}))).then(function(){var a=Array.prototype.slice.call(arguments),c=a.filter(function(a){return a!==b});return 0===c.length?[]:g(c,f).then(function(a){return h(a,f)})})})}function g(e,f){if(!e||0===e.length)return j.when([]).promise();var g=c(f);return l.loadJS(n.getResourceUrl({name:"lib/jSZip.js",namespace:"skuid",modstamp:a.version.date})).then(function(){var c=(new window.JSZip).folder("src"),f=c.folder("staticresources"),h=function(b,c){return a.Mustache.render(b,c)},i=h(B,e);c.file("package.xml",i),g(!1,"Building Deployment... ");var m=1;return j.when.apply(j,e.map(d(function(a){g(!1,"Building Deployment... ("+m+++"/"+e.length+")");var c,d,f=a.name,i=a.contentType,n=a.content;return a.description&&(a.description=l.encodeHTML(a.description)),d=h(C,j.extend({cacheControl:"private",contentType:"text/javascript"},a)),i==p.ZIP&&j.isArray(n)&&(c=new window.JSZip,k(n,function(a,d){c.file(d.name,d.content,{base64:b(d.contentType)})}),n=c.generate({type:"base64",compression:"DEFLATE"})),{name:f,metaXML:d,content:n,isBase64:b(i)}}))).then(function(){var a=Array.prototype.slice.call(arguments);return k(a,function(a,b){var c=b.name;f.file(c+".resource",b.content,{base64:b.isBase64}),f.file(c+".resource-meta.xml",b.metaXML)}),g(!1,"Building Deployment... Compressing"),c.generate({type:"base64",compression:"DEFLATE"})})})}function h(b,d){var e=c(d),f=j.Deferred();return l.loadJS(n.getResourceUrl({name:"lib/jSForce.js",namespace:"skuid",modstamp:a.version.date})).then(function(){function a(){g.metadata.checkDeployStatus(c,!0,function(b,c){e(c.done,"Processing Deployment... "+(c.state||c.status)+("InProgress"===c.status?" (t: "+c.numberComponentsTotal+", d: "+c.numberComponentsDeployed+", e: "+c.numberComponentErrors+")":"")),c.done?f.resolve(c):window.setTimeout(a,500)})}var c,d=window.jsforce,g=new d.Connection({sessionId:l.userInfo.sessionId});return g.metadata.pollTimeout=1e3,g.metadata.pollTimeout=3e4,e(!1,"Sending Deployment..."),g.metadata.deploy(b,{},function(b,d){c||(e(d.done,"Processing Deployment... "+d.state),c=d.id,a())})}),f.promise()}function i(a,b){var c;return arguments.length>1?c=a:(c=a[t],b=a[u]),("skuid_pgsp_"+c+"_"+b).replace(/[^a-zA-Z0-9_]/g,"_").replace(/_+/g,"_").slice(0,50).replace(/_$/,"")}var j=a.$,k=j.each,l=a.utils,m=l.makeXMLDoc,n=a.platform,o=a.constants,p=o.MIME_TYPES,q=a.pageSupport||(a.pageSupport={}),r=[p.ZIP],s=l.getLayoutFields(),t=n.getEntityFieldName("page","id"),u=n.getEntityFieldName("page","name"),v=n.getEntityFieldName("page","is_master_page"),w="skuid__Pages__r",x=[t,u,v].concat(s),y="> resources > javascript > jsitem",z='[location="inline"], [location="inlinesnippet"], [location="inlinecomponent"]',A=' xmlns="http://soap.sforce.com/2006/04/metadata"',B='<?xml version="1.0" encoding="UTF-8"?><Package'+A+"><types>{{#.}}<members>{{name}}</members>{{/.}}<name>StaticResource</name></types><version>39.0</version></Package>",C='<?xml version="1.0" encoding="UTF-8"?><StaticResource'+A+"><cacheControl>{{cacheControl}}</cacheControl><contentType>{{contentType}}</contentType><description>{{description}}</description></StaticResource>";j.extend(q,{generateFiles:f,getFileNameForPage:i})}(window.skuid);