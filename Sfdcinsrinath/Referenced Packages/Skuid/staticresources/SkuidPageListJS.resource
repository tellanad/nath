"use strict";!function(a){var b=a.sfdc,c=b.api,d=a.utils,e=a.$,f=c.SObject,g=c.query,h=c.escapeMetadataBody,i=d.size,j=a.snippet.register;j("skuid.pageList.previewPage",function(){var b=arguments[0],c=a.snippet.get("skuid.builder.page.preview");c&&c({model:b.model,row:b.item?b.item.row:b.row})}),j("skuid.pageList.bytesToKBs",function(){var b=arguments[0],c=arguments[1],d=0;e.isNumeric(c)&&(d=e.number(c/1e3,1)+" KB"),a.ui.getFieldRenderer("TEXT").read(b,d)}),j("Multipicklist",function(){a.ui.getFieldRenderer("MULTIPICKLIST").edit(arguments[0],d.decodeHTML(arguments[1]))}),j("skuid.page.packagePages",function(b){var c=b.srName,d=b.srDescription,i="SELECT Id, Name, Description FROM StaticResource WHERE Name = '"+c+"'",j=a.model.getModel("pgs__pagedata"),k=[],l="SELECT Id, Name, skuid__Type__c, skuid__UniqueId__c, skuid__Module__c, skuid__Composer_Settings__c, skuid__MasterPage__c, skuid__MasterPage__r.Name, skuid__MasterPage__r.skuid__UniqueId__c, skuid__IsMaster__c, skuid__Layout__c, skuid__Layout2__c, skuid__Layout3__c, skuid__Layout4__c, skuid__Layout5__c FROM skuid__Page__c WHERE Id IN ('";if(e.each(j.registeredItems,function(){this.selected&&k.push(this.row.Id)}),0===k.length)return void e.blockUI({message:"Please select at least one Page for your Page Pack",timeout:2500});l+=k.join("','")+"') ORDER BY skuid__Module__c, Name",e.blockUI({message:"Getting Page and StaticResource records..."});var m,n,o=g(i),p=g(l);e.when(p).then(function(a){n=a.records}),e.when(o).then(function(a){m=a.records}),e.when(o,p).then(function(){var b,g=e.Deferred();m.length>0?(b=new f("StaticResource",{Id:m[0].Id,CacheControl:"Private"}),g.resolve()):(e.blockUI({message:"Creating StaticResource..."}),b=new f("StaticResource",{Name:c,Description:d,Body:h(JSON.stringify([])),CacheControl:"Private"}),b.insert({success:function(){g.resolve()},error:function(a){g.reject({resourceName:c,errorMessage:a.responseJSON[0].message})}})),e.when(g).then(function(){e.blockUI({message:"Packaging Pages into StaticResource..."}),b.Body=h(JSON.stringify(n)),b.ContentType="application/json",e.when(b.update()).then(function(){e.blockUI({message:'The "'+c+'" Page Pack was created/updated successfully!',timeout:3e3}),e(".ui-dialog-content").last().dialog("close"),a.$M("pgs__PagesInStaticResources").updateData()},function(a){e.blockUI({message:'There was an error creating the "'+c+'" Page Pack'+(a&&a.errorMessage?":\n\n"+a.errorMessage:"."),timeout:5e3})})},function(a){e.blockUI({message:'There was an error creating the "'+a.resourceName+'" Page Pack:\n\n'+a.errorMessage,timeout:5e3})})})}),j("skuid.page.packagePagesInModules",function(a){var b=a.model,c=a.row,d=b.getFieldValue(c,"skuid__Module__c",!0);if(!d)return void window.alert("Please select a Module.");e.blockUI({message:"Retrieving Page and StaticResource records..."});var j,k,l=d.split(";"),m="('"+l.join("','")+"') ",n="('"+l.join("Pages','")+"Pages') ",o=g("select Id, Name from StaticResource where Name in "+n),p=g("select Id, Name, skuid__Type__c, skuid__UniqueId__c, skuid__Module__c, skuid__Composer_Settings__c, skuid__MasterPage__c, skuid__MasterPage__r.Name, skuid__MasterPage__r.skuid__UniqueId__c, skuid__IsMaster__c, skuid__Layout__c, skuid__Layout2__c, skuid__Layout3__c, skuid__Layout4__c, skuid__Layout5__c from skuid__Page__c where skuid__Module__c in "+m+"order by skuid__Module__c, Name");e.when(p).then(function(a){j=a.records}),e.when(o).then(function(a){k=a.records}),e.when(o,p).then(function(){e.blockUI({message:"Checking for Resources that may need to be created..."});var a={},b={},c={};e.each(k,function(){a[this.Name.substring(0,this.Name.indexOf("Pages"))]=new f("StaticResource",{Name:this.Name,Id:this.Id,Body:this.Body,CacheControl:"Private"})}),e.each(j,function(){var d=a[this.skuid__Module__c],e=c[this.skuid__Module__c];d||(b[this.skuid__Module__c]=1),e||(e=c[this.skuid__Module__c]=[]),e.push(this)});var d=e.Deferred(),g={};e.each(b,function(b){var c=b+"Pages",e=new f("StaticResource",{Name:c,Body:h(JSON.stringify([])),CacheControl:"Private"});a[b]=e,g[c]=1,e.insert({success:function(){delete g[c],0===i(g)&&d.resolve()},error:function(a){d.reject({resourceName:c,errorMessage:a.responseJSON[0].message})}})}),0===i(b)&&d.resolve(),e.when(d).then(function(){e.blockUI({message:"Packaging Pages into StaticResources..."});var b=e.Deferred(),d=i(c);e.each(c,function(c,f){var g=a[c];g&&(g.Body=h(JSON.stringify(f)),g.ContentType="application/json",e.when(g.update()).then(function(){0===--d&&b.resolve()}))}),e.when(b).then(function(){var a=[];e.each(c,function(b){a.push(b+"Pages")}),e.blockUI({css:{"text-align":"left"},message:"Module Pages packaged successfully!<br/><br/>The following StaticResources were updated, or created if they did not exist before:<br/><ul><li>"+a.join("</li><li>")+"</ul>",timeout:5e3})})},function(a){e.blockUI({message:'There was an error creating the new StaticResource "'+a.resourceName+'":\n\n'+a.errorMessage,timeout:7500})})})}),j("skuid.pageList.packagePages",function(){var b=arguments[0],c=b.model,d=b.row,f={srName:c.getFieldValue(d,"Name"),srDescription:c.getFieldValue(d,"Description")},g=e("input[name='tab-radio-PagePackDetailsTabSet']");e.each(g,function(){var b=e(this);if(!0===b.prop("checked")&&"1"===b.val()){var c=a.model.getModel("pgs__PagesInStaticResources"),d=c.getRowById(e("input:radio:checked[name='existingPagePack']").val());f.srName=c.getFieldValue(d,"Name"),f.srDescription=c.getFieldValue(d,"Description")}});var h=a.snippet.getSnippet("skuid.page.packagePages");h&&h(e.extend(b,f))}),j("skuid.pageList.refreshPages",function(){var b=[],c=e("#pageSRSelect").find("input");e.each(c,function(){var a=e(this),c=a.val();null!==c&&!0===a.prop("checked")&&b.push(c)}),b.length>0&&(a.$.blockUI({message:"Refreshing Pages in selected Static Resources..."}),a.PageListControllerExtension.RefreshPagesFromStaticResource(JSON.stringify(b),function(b){a.model.getModel("pgs__pagedata").updateData().then(function(){if(b.isSuccess){var c=a.snippet.get("skuid.pageList.snippets.regenPackSupportFiles");if(c)return c(b.pageSummaries)}}).then(function(){if(b&&!0===b.isSuccess)a.$.blockUI({message:"Success!",timeout:1500});else{var c="There was an error refreshing one or more pages";b&&b.errorList&&b.errorList.length>0&&(c+=":",e.each(b.errorList,function(a,b){c+="<br/>\n<br/>\n"+ ++a+". "+b})),a.$.blockUI({message:c,timeout:7500})}})}))})}(skuid);