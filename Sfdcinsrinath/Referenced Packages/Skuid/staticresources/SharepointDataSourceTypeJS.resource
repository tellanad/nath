"use strict";!function(a){var b=a.$,c=a.utils,d=c.makeXMLDoc,e=c.mergeAsTextInContext,f=a.dataSource.utils,g=b.Deferred,h=function(a,b){return-1!==a.indexOf("_api")&&(a=a.substring(0,a.indexOf("_api"))),c.combineUrls(a,"_layouts/download.aspx?SourceUrl=")+b},i=function(a){return"SkuidSharepoint-"+a+"-Login-"},j=function(a){if(!a)return"Error";var b=a.body,c=d(b),e=c.children("m\\:code").first().text().split(",");return e[1]&&e[1].trim&&e[1].trim()},k=function(a){if(a){var c=i(a.name);b.removeCookie(c+"FedAuth"),b.removeCookie(c+"rtFa"),b.removeCookie(c+"Digest"),a.authentication.success=!1,a.removeStoredAuthData()}},l=function(a){var c=b.Deferred(),d=a.dataSource,e=function(){var a=d.authentication;return"apex"===a.authMethod&&"Sharepoint_SharedLogin"===a.providerName},f=i(d.name),g=function(){a.headers||(a.headers={}),b.cookie.raw=!0,a.headers.Cookie="FedAuth="+b.cookie(f+"FedAuth")+"; rtFa="+b.cookie(f+"rtFa")+";",a.headers["X-RequestDigest"]=b.cookie(f+"Digest"),b.cookie.raw=!1};return!d.isAuthenticated()&&e()&&function(){return b.cookie(f+"FedAuth")&&b.cookie(f+"rtFa")&&b.cookie(f+"Digest")}()&&(d.authentication.success=!0),d.authenticate().done(function(){d.isAuthenticated()&&e()&&g(),c.resolve(a)}).fail(function(a){k(d),c.reject(a)}),c.promise()};if(!a.dataSource.getType("Sharepoint")){new a.dataSource.core.ODataDataSourceTypeBase({name:"Sharepoint",getKeyFields:function(a){var c,d,e={},f=a.key;return b.isArray(f)&&(f=f[0]),f&&f.propertyRef&&(c=f.propertyRef[0].name,d=a.propertyMap[c],"Edm.Boolean"===d.type&&(f.propertyRef[0].name="ID"),b.each(f.propertyRef,function(a,b){e[b.name]={id:b.name}})),e},getEntityContainerToList:function(){return"ListData"},supportsBatch:function(){return b.Deferred().resolve(!0).promise()},authenticateAndGetMetadata:function(a){var b=this;return l(a).then(function(){return b.getMetadata(a)})},isDefFilterable:function(a){return"Edm.String"===a.type&&"BaseName"!==a.name},coerceEntitySetList:function(a){a.push("SP.Files")},getUploadMethods:function(){function d(d,g,h,i,k,m){function n(a,b){for(var c=a.length,d=[],e=Math.ceil(c/b),f=0;f<b;f++)d[f]=a.slice(e*f,e*(f+1));return d}function o(a){if(a&&a.body){try{var b=JSON.parse(a.body)}catch(a){return j(a)}if(b&&b.error&&b.error.message&&b.error.message.value)return b.error.message.value}return"Had an error"}function p(a,c){c||(c={}),c=b.extend({overwrite:!1},c);var e=c.overwrite;i({fileName:h.filename||d.name});var f=x+"/web/getfolderbyserverrelativeurl('"+B+"')/files/add(overwrite="+e+",url='"+v+"')",g=w.createHTTPRequest({url:f,headers:h.headers,method:"POST",contentType:"application/octet-stream",body:a});return w.makeRequest(g)}function q(){m({loaded:G,total:t});var a=x+C+"startupload(uploadId=guid'"+D+"')",b=w.createHTTPRequest({url:a,headers:h.headers,method:"POST",contentType:"application/octet-stream",body:u[0]});return w.makeRequest(b).then(function(a){r(a)},function(a){k({message:o(a)})})}function r(a){var b=JSON.parse(a.body).d,c=b.StartUpload?parseInt(b.StartUpload):parseInt(b.ContinueUpload);G++,m({loaded:G,total:t}),l(h).then(function(){if(h.headers.Accept="application/json; odata=verbose",G===t)s(c);else{var a=x+C+"continueupload(uploadId=guid'"+D+"',fileOffset="+c+")",b=w.createHTTPRequest({url:a,headers:h.headers,method:"POST",contentType:"application/octet-stream",body:u[G-1]});w.makeRequest(b).then(r,function(a){k({message:o(a)})})}})}function s(a){var b=x+C+"finishupload(uploadId=guid'"+D+"',fileOffset="+a+")",c=w.createHTTPRequest({url:b,headers:h.headers,method:"POST",contentType:"application/octet-stream",body:u[G-1]});w.makeRequest(c).then(function(){k()},function(a){k({message:o(a)})})}var t,u,v=encodeURIComponent(c.renameFileWhileKeepingExtension(d.name,e(h.filename,h))),w=h.uploadMethod.dataSource,x=w&&w.serviceUrl?w.serviceUrl:"",y={row:g.row,model:g.model},z={createFields:!1},A=g.options.xmlDef.attr("foldername"),B=A?f.mergeThenURLEncode(A,y,z):encodeURIComponent("/Shared Documents"),C="/web/getfolderbyserverrelativeurl('"+B+"')/files/getbyurl('"+v+"')/",D=c.rfc4122v4GUID(),E=d.size,F=a.platform.getMaxProxyRequestPayload(),G=1;E&&(h.dataSource=w,c.readFileAsBase64(d).then(function(a){u=a,t=Math.ceil(E/F),1===t?l(h).then(function(){p(u,{overwrite:!0}).then(function(){k()},function(a){k({message:o(a)})})}):l(h).then(function(){u=n(u,t),h.headers.Accept="application/json; odata=verbose",p("42",{overwrite:!1}).then(q,function(a){var b=o(a);b.includes("already exists")?q():k({message:b})})})}))}return{relative_server_url:{label:"Relative Server URL",upload:d,hasDescription:!1,hasParent:!1,builderProps:[{id:"foldername",type:"text",label:"Relative folder URL",defaultValue:"/Shared Documents",helptext:'This is the relative server url for the folder you want this file to be uploaded to. Example: "/Shared Documents/SubFolder1/SubFolder2"'}]}}},getActions:f.getActionsStatic,createActions:function(a){return{"download-file":{builderProps:[{label:"File URL",id:"key",type:"template",location:"attribute",defaultValue:"{{Url}}"},{label:"Name of File",id:"name",type:"template",location:"attribute",defaultValue:"{{Name}}"}],runtimeExecution:function(b,c,d){d=d||{};var i=g(),j=f.mergeThenURLEncode(b.attr("key")||"{{Url}}",d),k=e(b.attr("name")||"{{Name}}",d),l=h(a.serviceUrl,j);return k&&j?(f.downloadWithLink(k,l),i.resolve().promise()):i.reject().promise()},label:"Download File"}}}})}}(skuid);